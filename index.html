<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mutfak Markası | Satış Performans Raporu</title>
    
    <!-- Google Fonts: Inter (Swiss Design Standard) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons (Minimalist Icon Set) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- SheetJS (Excel Parser) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            color-scheme: light;
            --brand-primary: #7989ff;
            --brand-secondary: #9a8cff;
            --brand-accent: #ffa7d9;
            --brand-soft: #eef2ff;
            --brand-ink: #2f2b4a;
            --brand-muted: #7e80a6;
            --card-highlight: linear-gradient(135deg, rgba(121, 137, 255, 0.18), rgba(255, 167, 217, 0.12));
        }

        body {
            font-family: 'Inter', sans-serif;
            background:
                radial-gradient(1300px circle at -15% -10%, rgba(121, 137, 255, 0.25), transparent 60%),
                radial-gradient(900px circle at 120% -20%, rgba(255, 167, 217, 0.2), transparent 55%),
                linear-gradient(180deg, #f6f8ff 0%, #f3f5ff 45%, #fdf8ff 100%);
            color: var(--brand-ink);
            min-height: 100vh;
            position: relative;
        }

        body::before,
        body::after {
            content: '';
            position: fixed;
            width: 460px;
            height: 460px;
            border-radius: 999px;
            filter: blur(120px);
            opacity: 0.45;
            z-index: -1;
            pointer-events: none;
        }

        body::before {
            background: rgba(121, 137, 255, 0.45);
            top: -140px;
            left: -200px;
        }

        body::after {
            background: rgba(255, 167, 217, 0.45);
            bottom: -220px;
            right: -180px;
        }

        .chart-container {
            position: relative;
            height: 100%;
            width: 100%;
        }

        .floating-shell {
            position: relative;
            border-radius: 36px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(26px);
            border: 1px solid rgba(255, 255, 255, 0.75);
            box-shadow: 0 25px 80px -40px rgba(103, 118, 255, 0.45);
            overflow: hidden;
        }

        .floating-shell::after {
            content: '';
            position: absolute;
            inset: 0;
            background: var(--card-highlight);
            opacity: 0.45;
            pointer-events: none;
        }

        .floating-shell > * {
            position: relative;
            z-index: 1;
        }

        .glass-card {
            position: relative;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.92), rgba(248, 250, 255, 0.86));
            border: 1px solid rgba(255, 255, 255, 0.9);
            border-radius: 28px;
            box-shadow: 0 30px 70px -45px rgba(93, 108, 224, 0.55);
            backdrop-filter: blur(22px);
            overflow: hidden;
        }

        .glass-card::after {
            content: '';
            position: absolute;
            inset: 0;
            background: var(--card-highlight);
            opacity: 0.55;
            pointer-events: none;
        }

        .glass-card > * {
            position: relative;
            z-index: 1;
        }

        .kpi-card {
            position: relative;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.96), rgba(245, 247, 255, 0.85));
            border: 1px solid rgba(255, 255, 255, 0.9);
            border-radius: 28px;
            box-shadow: 0 32px 75px -45px rgba(118, 134, 255, 0.6);
            overflow: hidden;
            padding: 1.75rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: -60px;
            right: -40px;
            width: 220px;
            height: 220px;
            border-radius: 999px;
            background: linear-gradient(135deg, rgba(121, 137, 255, 0.35), rgba(255, 167, 217, 0.25));
            filter: blur(12px);
            pointer-events: none;
        }

        .kpi-card > * {
            position: relative;
            z-index: 1;
        }

        .kpi-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            border-radius: 18px;
            background: linear-gradient(135deg, rgba(121, 137, 255, 0.35), rgba(255, 167, 217, 0.25));
            color: var(--brand-primary);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.9);
        }

        .kpi-pill {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--brand-muted);
            background: rgba(238, 242, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.85);
            padding: 0.35rem 0.75rem;
            border-radius: 999px;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .kpi-pill i {
            color: var(--brand-primary);
        }

        .kpi-title {
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.3em;
            text-transform: uppercase;
            color: rgba(60, 63, 109, 0.7);
        }

        .kpi-value {
            font-size: 2.25rem;
            font-weight: 600;
            letter-spacing: -0.01em;
            color: var(--brand-ink);
            line-height: 1.1;
        }

        .kpi-value span {
            font-size: 1rem;
            font-weight: 500;
            color: rgba(71, 74, 120, 0.6);
            margin-left: 0.35rem;
        }

        .section-title {
            font-weight: 600;
            color: #2d3162;
            letter-spacing: -0.01em;
        }

        .section-title span.label {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 42px;
            height: 42px;
            border-radius: 16px;
            background: linear-gradient(135deg, rgba(121, 137, 255, 0.35), rgba(255, 167, 217, 0.25));
            color: var(--brand-primary);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.9);
        }

        .floating-select {
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.9);
            background: rgba(255, 255, 255, 0.9);
            color: var(--brand-muted);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.85), 0 8px 16px -12px rgba(117, 131, 255, 0.6);
            transition: box-shadow 0.2s ease, transform 0.2s ease;
        }

        .floating-select:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px rgba(121, 137, 255, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.85);
        }

        .floating-button {
            border-radius: 16px;
            background: linear-gradient(135deg, #818dff, #ffa7d9);
            color: white;
            font-weight: 600;
            padding: 0.65rem 1.5rem;
            box-shadow: 0 18px 45px -22px rgba(121, 137, 255, 0.85);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .floating-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 24px 55px -20px rgba(121, 137, 255, 0.8);
        }

        .floating-button:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px rgba(121, 137, 255, 0.25),
                0 18px 45px -22px rgba(121, 137, 255, 0.65);
        }

        .floating-input::file-selector-button,
        .floating-input::-webkit-file-upload-button {
            border-radius: 14px;
            border: 0;
            background: rgba(121, 137, 255, 0.12);
            color: var(--brand-primary);
            font-weight: 600;
            padding: 0.35rem 0.85rem;
            cursor: pointer;
            transition: background 0.2s ease, color 0.2s ease;
        }

        .floating-input:hover::file-selector-button,
        .floating-input:hover::-webkit-file-upload-button,
        .floating-input:focus-visible::file-selector-button,
        .floating-input:focus-visible::-webkit-file-upload-button {
            background: rgba(121, 137, 255, 0.2);
            color: white;
        }

        .floating-input {
            color: var(--brand-muted);
            cursor: pointer;
        }

        #kpi-tooltip {
            backdrop-filter: blur(18px);
            background: rgba(47, 43, 74, 0.92);
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 18px 45px -24px rgba(28, 24, 52, 0.6);
        }

        footer {
            color: rgba(82, 84, 122, 0.7);
        }
    </style>
    
    <!-- Tailwind Config for Brand Colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            DEFAULT: '#7989FF',
                            light: '#9A8CFF',
                            dark: '#5965D8',
                            accent: '#FFA7D9',
                            soft: '#EEF2FF',
                            highlight: '#FFE3F3'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="antialiased min-h-screen pb-12 relative text-[var(--brand-ink)]">

    <!-- YENİ: KPI Tooltip (Başlangıçta gizli) -->
    <div id="kpi-tooltip" class="absolute z-30 hidden p-4 text-sm text-white rounded-2xl shadow-2xl min-w-[220px]" style="pointer-events: none;"></div>

    <!-- Header -->
    <header class="sticky top-0 z-20 pt-6 pb-4">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="floating-shell flex flex-col gap-6 md:flex-row md:items-center md:justify-between px-6 py-5">
                <div class="flex items-center gap-4">
                    <div class="kpi-icon text-lg font-semibold uppercase tracking-wide">M</div>
                    <div>
                        <h1 class="text-2xl font-semibold tracking-tight text-[#262a58]">Mutfak Markası</h1>
                        <p class="text-sm text-[rgba(82,84,122,0.75)]">Satış Performans Raporu</p>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                    <div class="flex items-center gap-3">
                        <select id="channelFilter" class="floating-select text-sm px-3 py-2 cursor-pointer focus:ring-2 focus:ring-[#aab6ff] focus:outline-none">
                            <option value="all">Tüm Kanallar</option>
                            <option value="Bayi">Bayi</option>
                            <option value="İntema">İntema</option>
                        </select>
                    </div>

                    <div class="flex items-center gap-3 sm:border-l sm:border-white/50 sm:pl-4 sm:ml-2">
                        <input type="file" id="fileUploader" accept=".xlsx, .xls, .csv" class="floating-input text-sm w-full max-w-xs">
                        <button id="uploadButton" class="floating-button text-sm">
                            Yükle & Güncelle
                        </button>
                    </div>
                    <div class="text-sm text-[rgba(82,84,122,0.75)] text-left sm:text-right sm:border-l sm:border-white/50 sm:pl-4 sm:ml-2">
                        <p class="text-xs uppercase tracking-wide text-[rgba(123,127,167,0.8)]">Veri Kaynağı</p>
                        <span id="dataSource" class="font-semibold text-[#2d3162]">Mock Data</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 space-y-12">

        <!-- KPI Cards Section -->
        <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">

            <!-- Card 1 (YENİ: ID eklendi) -->
            <div id="kpi-gelir-card" class="kpi-card cursor-help">
                <div class="flex justify-between items-start mb-6 relative">
                    <div class="kpi-icon text-xl">
                        <i class="ph ph-currency-tr"></i>
                    </div>
                    <span id="kpi-gelir-pct" class="kpi-pill">
                        <i class="ph ph-arrow-right text-sm"></i>
                        <span>-</span>
                    </span>
                </div>
                <div class="space-y-3">
                    <h3 class="kpi-title">Toplam Tutar</h3>
                    <p id="kpi-gelir-val" class="kpi-value">₺0</p>
                </div>
            </div>

            <!-- Card 2 -->
            <div id="kpi-unite-card" class="kpi-card cursor-help">
                <div class="flex justify-between items-start mb-6 relative">
                    <div class="kpi-icon text-xl">
                        <i class="ph ph-package"></i>
                    </div>
                    <span id="kpi-unite-pct" class="kpi-pill">
                        <i class="ph ph-arrow-right text-sm"></i>
                        <span>-</span>
                    </span>
                </div>
                <div class="space-y-3">
                    <h3 class="kpi-title">Satılan Ünite</h3>
                    <p id="kpi-unite-val" class="kpi-value">0<span>Adet</span></p>
                </div>
            </div>

            <!-- Card 3 -->
            <div id="kpi-ort-card" class="kpi-card cursor-help">
                <div class="flex justify-between items-start mb-6 relative">
                    <div class="kpi-icon text-xl">
                        <i class="ph ph-shopping-cart"></i>
                    </div>
                    <span id="kpi-ort-pct" class="kpi-pill">
                        <i class="ph ph-arrow-right text-sm"></i>
                        <span>-</span>
                    </span>
                </div>
                <div class="space-y-3">
                    <h3 class="kpi-title">Ort. Sipariş Değeri</h3>
                    <p id="kpi-ort-val" class="kpi-value">₺0</p>
                </div>
            </div>

            <!-- Card 4 (YENİ: Ort. BK) -->
            <div id="kpi-bk-card" class="kpi-card cursor-help">
                <div class="flex justify-between items-start mb-6 relative">
                    <div class="kpi-icon text-xl">
                        <i class="ph ph-percent"></i>
                    </div>
                    <span id="kpi-bk-pct" class="kpi-pill">
                        <i class="ph ph-arrow-right text-sm"></i>
                        <span>-</span>
                    </span>
                </div>
                <div class="space-y-3">
                    <h3 class="kpi-title">Ort. BK</h3>
                    <p id="kpi-bk-val" class="kpi-value">0.0%</p>
                </div>
            </div>

        </section>

        <!-- Main Charts Layout (GÜNCELLENDİ: Tam genişlikte) -->

        <!-- Left Column: Sales Trend -->
        <div class="glass-card p-8 lg:p-10 shadow-2xl">
            <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between mb-6">
                <h2 class="section-title flex items-center gap-3 text-lg lg:text-xl">
                    <span class="label text-base">
                        <i class="ph ph-trend-up"></i>
                    </span>
                    Aylık Satış Trendi (Sadece Mutfak & Ek Sipariş)
                </h2>
                <select class="floating-select text-sm px-3 py-2 cursor-pointer focus:ring-2 focus:ring-[#aab6ff] focus:outline-none">
                    <option>Tüm Yıl</option>
                </select>
            </div>
            <div class="relative h-[350px] w-full">
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <!-- Bottom Section: City Sales (Yukarı taşındı) -->
        <div class="glass-card p-8 lg:p-10 shadow-2xl">
            <h2 class="section-title text-lg lg:text-xl mb-6 flex items-center gap-3">
                <span class="label text-base">
                    <i class="ph ph-map-pin"></i>
                </span>
                Satış Noktası Dağılımı (Adet)
            </h2>
            <div class="relative h-[250px] w-full">
                <canvas id="cityChart"></canvas>
            </div>
        </div>

        <!-- YENİ: 4'lü Kırılım Bölümü (Pie Charts) -->
        <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            
            <!-- Model Ciro -->
            <div class="glass-card p-8 lg:p-9 h-[400px] flex flex-col">
                <h2 class="section-title text-lg mb-4 flex items-center gap-3">
                    <span class="label text-sm">
                        <i class="ph ph-chart-pie"></i>
                    </span>
                    Modele Göre Ciro (TL)
                </h2>
                <div class="relative flex-1">
                    <canvas id="modelRevenueChart"></canvas>
                </div>
            </div>

            <!-- Model Adet -->
            <div class="glass-card p-8 lg:p-9 h-[400px] flex flex-col">
                <h2 class="section-title text-lg mb-4 flex items-center gap-3">
                    <span class="label text-sm">
                        <i class="ph ph-chart-pie-slice"></i>
                    </span>
                    Modele Göre Satış (Adet)
                </h2>
                <div class="relative flex-1">
                    <canvas id="modelUnitChart"></canvas>
                </div>
            </div>

            <!-- Malzeme Ciro -->
            <div class="glass-card p-8 lg:p-9 h-[400px] flex flex-col">
                <h2 class="section-title text-lg mb-4 flex items-center gap-3">
                    <span class="label text-sm">
                        <i class="ph ph-flower-lotus"></i>
                    </span>
                    Malzemeye Göre Ciro (TL)
                </h2>
                <div class="relative flex-1">
                    <canvas id="materialRevenueChart"></canvas>
                </div>
            </div>

            <!-- Malzeme Adet -->
            <div class="glass-card p-8 lg:p-9 h-[400px] flex flex-col">
                <h2 class="section-title text-lg mb-4 flex items-center gap-3">
                    <span class="label text-sm">
                        <i class="ph ph-flower-tulip"></i>
                    </span>
                    Malzemeye Göre Satış (Adet)
                </h2>
                <div class="relative flex-1">
                    <canvas id="materialUnitChart"></canvas>
                </div>
            </div>

        </section>


    </main>

    <footer class="max-w-7xl mx-auto px-4 py-8 text-center text-xs">
        <p>&copy; 2025 Mutfak Markası A.Ş. Tüm hakları saklıdır. Gizli Kurumsal Veri.</p>
    </footer>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        'use strict';

        (() => {
            // Global Chart Settings
            Chart.defaults.font.family = "'Inter', sans-serif";
            Chart.defaults.color = '#7f83aa';
            Chart.defaults.scale.grid.color = '#eceffd';
            Chart.defaults.plugins = Chart.defaults.plugins || {};
            Chart.defaults.plugins.legend = Chart.defaults.plugins.legend || {};
            Chart.defaults.plugins.legend.labels =
                Chart.defaults.plugins.legend.labels || {};
            Chart.defaults.plugins.legend.labels.color = '#7a7ea6';

            const BRAND_COLOR = '#7989FF';
            const BRAND_LIGHT = '#A6B3FF';
            const BRAND_DARK = '#5965D8';
            const BRAND_ACCENT = '#FFA7D9';
            const BRAND_GLOW = '#EEF2FF';

            // Global Chart Instances
            let trendChart, cityChart;
            let modelRevenueChart, modelUnitChart, materialRevenueChart, materialUnitChart;

            // Ay İsimleri (Türkçe)
            const monthNames = [
                'Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran',
                'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'
            ];

            // Filtreler için global değişkenler
            let rawExcelData = []; // Yüklenen ham veri
            const kpiBreakdowns = {}; // Tooltip verileri

            // Helper: Para Formatlama
            const formatCurrency = (value) =>
                new Intl.NumberFormat('tr-TR', {
                    style: 'currency',
                    currency: 'TRY',
                    minimumFractionDigits: 0
                }).format(value || 0);

            // Helper: Sayı Formatlama
            const formatNumber = (value) =>
                new Intl.NumberFormat('tr-TR').format(value || 0);

            // Helper: Yüzde Formatlama (0.xx -> XX.X%)
            const formatPercentage = (value) =>
                `${((value || 0) * 100).toFixed(1)}%`;

            // Helper: KPI Tooltip'i kur
            function setupTooltipListener(cardId, title, formatter) {
                const card = document.getElementById(cardId);
                const kpiTooltip = document.getElementById('kpi-tooltip');

                card.addEventListener('mouseover', (e) => {
                    const breakdown = kpiBreakdowns[cardId];
                    if (!breakdown || Object.keys(breakdown).length === 0) return;

                    let tooltipHtml = `<h4 class="text-[13px] font-semibold mb-2 text-white border-b border-white/10 pb-2">${title}</h4><ul class="space-y-1 text-xs">`;
                    const sortedBreakdown = Object.entries(breakdown).sort(
                        ([, a], [, b]) => b - a
                    );

                    for (const [key, value] of sortedBreakdown) {
                        tooltipHtml += `<li class="flex justify-between items-center text-white/80"><span class="text-white/60 mr-4">${key}:</span> <span class="font-semibold text-white">${formatter(
                    value
                )}</span></li>`;
                    }
                    tooltipHtml += '</ul>';

                    kpiTooltip.innerHTML = tooltipHtml;
                    kpiTooltip.classList.remove('hidden');
                });

                card.addEventListener('mousemove', (e) => {
                    kpiTooltip.style.left = `${e.pageX + 15}px`;
                    kpiTooltip.style.top = `${e.pageY}px`;
                });

                card.addEventListener('mouseout', () => {
                    kpiTooltip.classList.add('hidden');
                });
            }

            // --- Veri Yükleme ve İşleme Fonksiyonları ---

            // Dosya yükleme ana fonksiyonu
            async function handleFileUpload() {
                const fileInput = document.getElementById('fileUploader');
                const file = fileInput.files[0];
                const uploadButton = document.getElementById('uploadButton');

                if (!file) {
                    console.warn('Dosya seçilmedi.');
                    return;
                }

                uploadButton.innerText = 'İşleniyor...';
                uploadButton.disabled = true;

                try {
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });

                    const targetSheetName = 'Parekende_Detay';
                    const worksheet = workbook.Sheets[targetSheetName];

                    if (!worksheet) {
                        throw new Error(
                            `"${targetSheetName}" adında bir sayfa bulunamadı.`
                        );
                    }

                    const json_data = XLSX.utils.sheet_to_json(worksheet, {
                        header: 1,
                        defval: null
                    });

                    // Başlık satırını atla ve ham veriyi kaydet
                    rawExcelData = json_data.slice(1);

                    // Dashboard'u ilk kez işle ve render et
                    masterRender();

                    // Veri kaynağı adını güncelle
                    document.getElementById('dataSource').innerText = file.name;
                } catch (error) {
                    console.error('Dosya okunurken hata oluştu:', error);
                    alert(
                        `Hata: Dosya işlenemedi. "${error.message}" Lütfen dosya formatını kontrol edin.`
                    );
                } finally {
                    uploadButton.innerText = 'Yükle & Güncelle';
                    uploadButton.disabled = false;
                }
            }

            // Ana render fonksiyonu (filtreler değiştiğinde veya dosya yüklendiğinde)
            function masterRender() {
                if (rawExcelData.length === 0) {
                    console.log('Render için ham veri yok.');
                    return;
                }

                const selectedChannel = document.getElementById('channelFilter').value;

                // Ham veriyi filtrelere göre işle
                const processedData = processData(
                    rawExcelData,
                    selectedChannel
                );

                // İşlenmiş veriyle dashboard'u güncelle
                if (processedData) {
                    updateDashboard(processedData);
                }
            }

            // Excel tarih (serial) veya string'i JS Date'e çeviren helper
            function parseDate(excelDate) {
                if (excelDate instanceof Date) {
                    return excelDate; // Zaten doğru formatta
                }
                if (typeof excelDate === 'number' && excelDate > 25569) {
                    // Excel seri tarihi (1970-01-01 = 25569)
                    // UTC olarak al, timezone kaymasını engelle
                    return new Date(Math.round((excelDate - 25569) * 86400 * 1000) + new Date().getTimezoneOffset() * 60000);
                }
                if (typeof excelDate === 'string') {
                    // "2025-05-30" veya "DD.MM.YYYY" gibi string formatları dene
                    let date;
                    if (excelDate.includes('.')) {
                        // DD.MM.YYYY formatını YYYY-MM-DD'ye çevir
                        const parts = excelDate.split(' ')[0].split('.');
                        if (parts.length === 3) {
                            date = new Date(parts[2], parts[1] - 1, parts[0]);
                        }
                    } else {
                        date = new Date(excelDate);
                    }

                    if (date instanceof Date && !isNaN(date.getTime())) {
                        return date;
                    }
                }
                return null; // Geçersiz format
            }

            /**
             * Yüklenen veriyi işler ve dashboard için hazırlar.
             * VERİ EŞLEŞTİRME (VARSAYIMLAR):
             * A (0): Satış Noktası
             * E (4): Tür (FİLTRE: "Mutfak" veya "Ek Sipariş")
             * F (5): Kanal (FİLTRE: "Bayi" veya "İntema")
             * K (10): Adet
             * P (15): Sipariş No
             * T (19): Malzeme
             * V (21): Kapak Model
             * AG (32): Fatura Tarihi (Tarih)
             * AI (34): Toplam Tutar (Gelir)
             * AK (36): BK (Brüt Kâr)
             * AP (41): Maliyet (Cost)
             */
            function processData(allRows, channelFilter) {
                // 1. FİLTRELEME AŞAMASI
                const rows = allRows.filter((row) => {
                    if (!row) return false;

                    // Temel Filtre: Tür (E sütunu, index 4)
                    const type = row[4];
                    if (type !== 'Mutfak' && type !== 'Ek Sipariş') {
                        return false;
                    }

                    // Kanal Filtresi (F sütunu, index 5)
                    // DÜZELTME: trim() hatasını önlemek için string'e çevir ve null kontrolü yap
                    const channel = (row[5] || '').toString().trim();
                    if (channelFilter !== 'all') {
                        if (channel !== channelFilter) {
                            return false;
                        }
                    }
                    
                    // Filtrelenmiş satıra temizlenmiş kanalı ekle (sonraki adım için)
                    row.cleanedChannel = channel; 

                    return true; // Tüm filtrelerden geçti
                });

                if (rows.length === 0) {
                    console.warn('Filtrelerle eşleşen veri bulunamadı.');
                    // Grafikleri ve KPI'ları sıfırla
                    return getEmptyDataStructure();
                }

                // 2. AGREGASYON AŞAMASI
                let totalRevenue = 0;
                let totalUnits = 0;
                const orderSet = new Set();

                // KPI Tooltip verileri
                const revenueBreakdownChannel = {};
                const unitBreakdownChannel = {};
                const avgOrderValueBreakdown_Revenue = {};
                const avgOrderValueBreakdown_Units = {}; // DÜZELTME için eklendi
                const avgGrossProfitBreakdown = {};
                const channelMarginCounts = {};

                // Trend
                const monthlySales = new Array(12).fill(0);

                // Satış Noktası (Adet ve Tutar)
                const cityUnits = {};
                const cityRevenue = {}; // DÜZELTME için eklendi

                // Pie Chart'lar
                const modelRevenue = {};
                const modelUnits = {};
                const materialRevenue = {};
                const materialUnits = {};

                // BK KPI
                let totalGrossProfitMarginSum = 0;
                let grossProfitRowCount = 0;

                rows.forEach((row) => {
                    const revenue = parseFloat(row[34]) || 0; // AI
                    const units = parseInt(row[10]) || 0; // K
                    const date = parseDate(row[32]); // AG
                    const orderId = row[15]; // P
                    const model = row[21] || 'Bilinmiyor'; // V
                    const material = row[19] || 'Bilinmiyor'; // T
                    const city = row[0] || 'Bilinmiyor'; // A (Satış Noktası)
                    const channel = row.cleanedChannel; // F (Filtrelenmiş)
                    const cost = parseFloat(row[41]) || 0; // AP

                    // 1. KPI Hesaplamaları
                    totalRevenue += revenue;
                    totalUnits += units;
                    if (orderId) orderSet.add(orderId);

                    // KPI Tooltip verisi (Kanal)
                    revenueBreakdownChannel[channel] =
                        (revenueBreakdownChannel[channel] || 0) + revenue;
                    unitBreakdownChannel[channel] =
                        (unitBreakdownChannel[channel] || 0) + units;

                    // Ort. Sipariş Değeri Tooltip verisi (DÜZELTME)
                    avgOrderValueBreakdown_Revenue[channel] =
                        (avgOrderValueBreakdown_Revenue[channel] || 0) + revenue;
                    avgOrderValueBreakdown_Units[channel] =
                        (avgOrderValueBreakdown_Units[channel] || 0) + units;

                    // 2. Aylık Satış (Trend)
                    if (date) {
                        const month = date.getMonth(); // 0 = Ocak, 11 = Aralık
                        monthlySales[month] += revenue;
                    }

                    // 3. Satış Noktası (Adet ve Tutar)
                    cityUnits[city] = (cityUnits[city] || 0) + units;
                    cityRevenue[city] = (cityRevenue[city] || 0) + revenue; // DÜZELTME

                    // 4. Pie Chart Kırılımları
                    modelRevenue[model] = (modelRevenue[model] || 0) + revenue;
                    modelUnits[model] = (modelUnits[model] || 0) + units;
                    materialRevenue[material] =
                        (materialRevenue[material] || 0) + revenue;
                    materialUnits[material] = (materialUnits[material] || 0) + units;

                    // 5. Ort. BK Hesaplaması
                    if (revenue > 0) { // AP (cost) 0 olabilir veya olmayabilir
                        const margin = 1 - (cost / revenue);
                        totalGrossProfitMarginSum += margin;
                        grossProfitRowCount++;

                        // BK Tooltip verisi
                        avgGrossProfitBreakdown[channel] =
                            (avgGrossProfitBreakdown[channel] || 0) + margin;
                        channelMarginCounts[channel] =
                            (channelMarginCounts[channel] || 0) + 1;
                    }
                });

                // Ort. Sipariş Değeri (Toplam Gelir / Toplam Adet)
                const avgOrderValue = totalUnits > 0 ? totalRevenue / totalUnits : 0;

                // Ort. Sip. Değ. Tooltip için son hesaplama (DÜZELTME)
                const avgOrderValueTooltipData = {};
                for (const channel in avgOrderValueBreakdown_Revenue) {
                    const channelRevenue = avgOrderValueBreakdown_Revenue[channel];
                    const channelUnits = avgOrderValueBreakdown_Units[channel];
                    avgOrderValueTooltipData[channel] =
                        channelUnits > 0 ? channelRevenue / channelUnits : 0;
                }

                // Ort. BK Tooltip için son hesaplama
                const avgGrossProfitTooltipData = {};
                for (const channel in avgGrossProfitBreakdown) {
                    const channelMarginSum = avgGrossProfitBreakdown[channel];
                    const channelMarginCount = channelMarginCounts[channel] || 0;
                    avgGrossProfitTooltipData[channel] =
                        channelMarginCount > 0
                            ? channelMarginSum / channelMarginCount
                            : 0;
                }

                // Ort. BK
                const avgGrossProfit =
                    grossProfitRowCount > 0
                        ? totalGrossProfitMarginSum / grossProfitRowCount
                        : 0;

                // Veriyi sırala ve Top N (en iyi N) al
                const topCitiesByUnit = getTopNData(cityUnits, 10);
                
                // DÜZELTME: Top N'e göre Tutar verisini de hazırla
                const topCityRevenue = {};
                for (const city of Object.keys(topCitiesByUnit)) {
                     topCityRevenue[city] = cityRevenue[city] || 0;
                }

                // Pie chart'lar (Top 5 + Diğer)
                const topModelRevenue = getTopNData(modelRevenue, 5);
                const topModelUnits = getTopNData(modelUnits, 5);
                const topMaterialRevenue = getTopNData(materialRevenue, 5);
                const topMaterialUnits = getTopNData(materialUnits, 5);

                return {
                    kpis: {
                        totalRevenue,
                        totalUnits,
                        avgOrderValue,
                        avgGrossProfit,
                        revenueBreakdown: revenueBreakdownChannel,
                        unitBreakdown: unitBreakdownChannel,
                        avgOrderValueBreakdown: avgOrderValueTooltipData, // Düzeltilmiş
                        avgGrossProfitBreakdown: avgGrossProfitTooltipData
                    },
                    trendData: {
                        labels: monthNames,
                        data: monthlySales
                    },
                    cityData: {
                        labels: Object.keys(topCitiesByUnit),
                        dataUnits: Object.values(topCitiesByUnit),
                        dataRevenue: Object.values(topCityRevenue) // Düzeltilmiş
                    },
                    modelRevenueData: {
                        labels: Object.keys(topModelRevenue),
                        data: Object.values(topModelRevenue)
                    },
                    modelUnitData: {
                        labels: Object.keys(topModelUnits),
                        data: Object.values(topModelUnits)
                    },
                    materialRevenueData: {
                        labels: Object.keys(topMaterialRevenue),
                        data: Object.values(topMaterialRevenue)
                    },
                    materialUnitData: {
                        labels: Object.keys(topMaterialUnits),
                        data: Object.values(topMaterialUnits)
                    }
                };
            }

            // Boş veri döndüren helper (filtre sonucu boşsa)
            function getEmptyDataStructure() {
                const empty = { labels: [], data: [] };
                return {
                    kpis: {
                        totalRevenue: 0,
                        totalUnits: 0,
                        avgOrderValue: 0,
                        avgGrossProfit: 0,
                        revenueBreakdown: {},
                        unitBreakdown: {},
                        avgOrderValueBreakdown: {},
                        avgGrossProfitBreakdown: {}
                    },
                    trendData: { labels: monthNames, data: new Array(12).fill(0) },
                    cityData: { labels: [], dataUnits: [], dataRevenue: [] }, // Düzeltilmiş
                    modelRevenueData: empty,
                    modelUnitData: empty,
                    materialRevenueData: empty,
                    materialUnitData: empty
                };
            }

            // Pie chart güncelleme helper'ı
            function updatePieChart(chart, data, formatter) {
                chart.data.labels = data.labels;
                chart.data.datasets[0].data = data.data;

                // Renkleri veri sayısına göre ayarla
                chart.data.datasets[0].backgroundColor = generatePieColors(
                    data.labels.length
                );
                chart.data.datasets[0].borderWidth = 0;
                chart.data.datasets[0].hoverOffset = 6;

                if (formatter) {
                    chart.options.plugins.tooltip.callbacks.label = (context) => {
                        const label = context.label || '';
                        const value = context.raw || 0;
                        const sum = context.chart.data.datasets[0].data.reduce(
                            (a, b) => a + b,
                            0
                        );
                        const percentage =
                            sum > 0 ? ((value / sum) * 100).toFixed(1) + '%' : '0%';
                        return `${label}: ${formatter(value)} (${percentage})`;
                    };
                }
                chart.update();
            }

            // Dashboard'u güncelleyen ana fonksiyon
            function updateDashboard(data) {
                if (!data) return;

                // 1. KPI Kartlarını Güncelle
                document.getElementById('kpi-gelir-val').innerText = formatCurrency(
                    data.kpis.totalRevenue
                );
                document.getElementById('kpi-unite-val').innerHTML =
                    `${formatNumber(data.kpis.totalUnits)}<span>Adet</span>`;
                document.getElementById('kpi-ort-val').innerText = formatCurrency(
                    data.kpis.avgOrderValue
                );
                document.getElementById('kpi-bk-val').innerText = formatPercentage(
                    data.kpis.avgGrossProfit
                );

                // Tooltip verisini global objeye ata
                kpiBreakdowns['kpi-gelir-card'] = data.kpis.revenueBreakdown;
                kpiBreakdowns['kpi-unite-card'] = data.kpis.unitBreakdown;
                kpiBreakdowns['kpi-ort-card'] = data.kpis.avgOrderValueBreakdown;
                kpiBreakdowns['kpi-bk-card'] = data.kpis.avgGrossProfitBreakdown;

                // KPI yüzdelerini sıfırla
                document.querySelectorAll('[id$="-pct"]').forEach((el) => {
                    el.innerHTML = '<i class="ph ph-arrow-right text-sm"></i><span>-</span>';
                    el.className = 'kpi-pill';
                });

                // 2. Trend Grafiğini Güncelle
                trendChart.data.labels = data.trendData.labels;
                trendChart.data.datasets[0].data = data.trendData.data;
                trendChart.update();

                // 3. Şehir Grafiğini Güncelle (Adet)
                cityChart.data.labels = data.cityData.labels;
                cityChart.data.datasets[0].data = data.cityData.dataUnits; // Adet
                
                // DÜZELTME: Tooltip'e Tutar (Revenue) verisini ekle
                cityChart.options.plugins.tooltip.callbacks.label = (context) => {
                     const label = context.label || '';
                     const units = context.raw || 0;
                     return `${label}: ${formatNumber(units)} Adet`;
                };
                cityChart.options.plugins.tooltip.callbacks.afterLabel = (context) => {
                     const revenue = data.cityData.dataRevenue[context.dataIndex] || 0;
                     return `Tutar: ${formatCurrency(revenue)}`;
                };
                cityChart.update();

                // 4. Pie Grafikleri Güncelle
                updatePieChart(
                    modelRevenueChart,
                    data.modelRevenueData,
                    formatCurrency
                );
                updatePieChart(modelUnitChart, data.modelUnitData, formatNumber);
                updatePieChart(
                    materialRevenueChart,
                    data.materialRevenueData,
                    formatCurrency
                );
                updatePieChart(
                    materialUnitChart,
                    data.materialUnitData,
                    formatNumber
                );
            }

            // Helper: Veriyi Top N + "Diğer" olarak grupla
            function getTopNData(dataObject, topN = 5) {
                const sorted = Object.entries(dataObject)
                    // "Bilinmiyor" olanı en sona at
                    .filter(([key]) => key !== 'Bilinmiyor')
                    .sort(([, a], [, b]) => b - a);

                const otherData = dataObject['Bilinmiyor'] || 0;

                if (sorted.length <= topN) {
                    const finalData = Object.fromEntries(sorted);
                    if (otherData > 0) finalData['Bilinmiyor'] = otherData;
                    return finalData;
                }

                const topData = Object.fromEntries(sorted.slice(0, topN));
                // "Diğer"lerin toplamına "Bilinmiyor"u da ekle
                const otherSum =
                    sorted.slice(topN).reduce((sum, [, val]) => sum + val, 0) +
                    otherData;

                if (otherSum > 0) {
                    topData['Diğer'] = otherSum;
                }

                return topData;
            }

            // Pie Chart Renk paleti
            const PIE_COLORS = [
                '#7989FF',
                '#A6B3FF',
                '#FFA7D9',
                '#74D7FF',
                '#C7C9FF',
                '#FFE1F1',
                '#B8F0FF'
            ];

            function generatePieColors(count) {
                const colors = [];
                for (let i = 0; i < count; i++) {
                    colors.push(PIE_COLORS[i % PIE_COLORS.length]);
                }
                return colors;
            }

            // Pie/Doughnut chart oluşturan helper
            function createPieChart(canvasId, mockData, formatterCallback) {
                const ctx = document.getElementById(canvasId).getContext('2d');
                return new Chart(ctx, {
                    type: 'doughnut',
                    data: mockData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '65%',
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    font: { size: 11 },
                                    boxWidth: 10,
                                    usePointStyle: true,
                                    pointStyle: 'rectRounded'
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(46, 43, 82, 0.92)',
                                padding: 12,
                                titleColor: '#F5F6FF',
                                bodyColor: '#E6E8FF',
                                borderColor: 'rgba(255, 255, 255, 0.18)',
                                borderWidth: 1,
                                callbacks: {
                                    label: formatterCallback // Bu, update'de dinamik olarak ayarlanacak
                                }
                            }
                        }
                    }
                });
            }

            // Sayfa Yüklendiğinde Mock Veri ile Grafikleri Çiz
            function initializeChartsWithMockData() {
                // 1. Trend Chart (Area)
                const ctxTrend = document.getElementById('trendChart').getContext('2d');
                const gradientTrend = ctxTrend.createLinearGradient(0, 0, 0, 400);
                gradientTrend.addColorStop(0, 'rgba(121, 137, 255, 0.45)');
                gradientTrend.addColorStop(0.6, 'rgba(168, 180, 255, 0.18)');
                gradientTrend.addColorStop(1, 'rgba(255, 167, 217, 0)');

                trendChart = new Chart(ctxTrend, {
                    type: 'line',
                    data: {
                        labels: monthNames,
                        datasets: [
                            {
                                label: 'Satış Tutarı (TL)',
                                data: new Array(12).fill(0), // Başlangıçta boş
                                borderColor: BRAND_COLOR,
                                backgroundColor: gradientTrend,
                                borderWidth: 2,
                                tension: 0.4,
                                fill: true,
                                pointBackgroundColor: '#fff',
                                pointBorderColor: BRAND_COLOR,
                                pointBorderWidth: 2,
                                pointRadius: 4,
                                pointHoverRadius: 6
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(46, 43, 82, 0.95)',
                                titleColor: '#F5F6FF',
                                bodyColor: '#E6E8FF',
                                borderColor: 'rgba(255, 255, 255, 0.18)',
                                borderWidth: 1,
                                padding: 12,
                                displayColors: false,
                                callbacks: {
                                    label: (context) => formatCurrency(context.parsed.y)
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { borderDash: [4, 4] },
                                ticks: {
                                    callback: (value) => {
                                        if (value >= 1000000) {
                                            return '₺' + (value / 1000000).toFixed(1) + 'M';
                                        }
                                        if (value >= 1000) {
                                            return '₺' + (value / 1000).toFixed(0) + 'K';
                                        }
                                        return '₺' + value;
                                    }
                                },
                                border: { display: false }
                            },
                            x: {
                                grid: { display: false },
                                border: { display: false }
                            }
                        }
                    }
                });

                // 2. City Chart (Vertical Bar)
                const ctxCity = document.getElementById('cityChart').getContext('2d');
                const cityGradient = ctxCity.createLinearGradient(0, 0, 0, 260);
                cityGradient.addColorStop(0, 'rgba(121, 137, 255, 0.9)');
                cityGradient.addColorStop(1, 'rgba(255, 167, 217, 0.85)');

                cityChart = new Chart(ctxCity, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Satış Adedi',
                                data: [],
                                backgroundColor: cityGradient,
                                hoverBackgroundColor: '#8d9dff',
                                borderRadius: 16,
                                barThickness: 28,
                                maxBarThickness: 36,
                                borderSkipped: false
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(46, 43, 82, 0.92)',
                                padding: 12,
                                cornerRadius: 12,
                                titleColor: '#F5F6FF',
                                bodyColor: '#E6E8FF',
                                borderColor: 'rgba(255, 255, 255, 0.18)',
                                borderWidth: 1,
                                callbacks: {
                                    label: (context) =>
                                        formatNumber(context.raw) + ' Adet'
                                    // afterLabel -> updateDashboard içinde dinamik eklenir
                                }
                            }
                        },
                        scales: {
                            y: { display: false, beginAtZero: true },
                            x: {
                                grid: { display: false },
                                border: { display: false },
                                ticks: { font: { size: 11 } }
                            }
                        }
                    }
                });

                // 3. Kırılım Grafikleri (Pie)
                const currencyTooltip = (ctx) => {
                    if (!ctx.raw) return ' 0';
                    const sum = ctx.chart.data.datasets[0].data.reduce(
                        (a, b) => a + b,
                        0
                    );
                    const percentage =
                        sum > 0 ? ((ctx.raw / sum) * 100).toFixed(1) + '%' : '0%';
                    return ` ${ctx.label}: ${formatCurrency(ctx.raw)} (${percentage})`;
                };
                const numberTooltip = (ctx) => {
                    if (!ctx.raw) return ' 0';
                    const sum = ctx.chart.data.datasets[0].data.reduce(
                        (a, b) => a + b,
                        0
                    );
                    const percentage =
                        sum > 0 ? ((ctx.raw / sum) * 100).toFixed(1) + '%' : '0%';
                    return ` ${ctx.label}: ${formatNumber(ctx.raw)} Adet (${percentage})`;
                };

                const emptyPie = { labels: [], datasets: [{ data: [], backgroundColor: [] }] };

                modelRevenueChart = createPieChart(
                    'modelRevenueChart',
                    emptyPie,
                    currencyTooltip
                );
                modelUnitChart = createPieChart(
                    'modelUnitChart',
                    emptyPie,
                    numberTooltip
                );
                materialRevenueChart = createPieChart(
                    'materialRevenueChart',
                    emptyPie,
                    currencyTooltip
                );
                materialUnitChart = createPieChart(
                    'materialUnitChart',
                    emptyPie,
                    numberTooltip
                );

                // İlk KPI'ları mock veriye (veya sıfıra) göre doldur
                document.getElementById('kpi-gelir-val').innerText = formatCurrency(0);
                document.getElementById('kpi-unite-val').innerHTML = `${formatNumber(0)}<span>Adet</span>`;
                document.getElementById('kpi-ort-val').innerText = formatCurrency(0);
                document.getElementById('kpi-bk-val').innerText = '0.0%';
            }

            // DOM hazır olunca
            document.addEventListener('DOMContentLoaded', () => {
                // Mock grafikler
                initializeChartsWithMockData();

                // File upload
                document
                    .getElementById('uploadButton')
                    .addEventListener('click', handleFileUpload);

                // Filtreler
                document
                    .getElementById('channelFilter')
                    .addEventListener('change', masterRender);

                // KPI tooltip’leri
                setupTooltipListener('kpi-gelir-card', 'Satış Kanalı', formatCurrency);
                setupTooltipListener('kpi-unite-card', 'Satış Kanalı (Adet)', formatNumber);
                setupTooltipListener('kpi-ort-card', 'Ort. Sipariş Değeri (Kanal)', formatCurrency);
                setupTooltipListener('kpi-bk-card', 'Ort. BK (Kanal)', formatPercentage);
            });
        })();
    </script>
</body>
</html>